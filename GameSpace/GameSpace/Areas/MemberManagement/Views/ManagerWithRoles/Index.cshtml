@model IEnumerable<GameSpace.Areas.MemberManagement.Models.ManagerWithRoleVM>
@{
    ViewData["Title"] = "管理者與角色";

    // 保留側欄狀態（預設 admin）
    var sidebar = (string)(ViewBag.Sidebar ?? Context.Request.Query["sidebar"].ToString() ?? "admin");

    // 目前查詢狀態
    int? currentId = ViewBag.ManagerId as int?;
    string currentName = ViewBag.ManagerName as string;
    string currentRole = ViewBag.RoleName as string;

    string sortBy = (ViewBag.SortBy as string) ?? "id";     // id | role
    string sortDir = (ViewBag.SortDir as string) ?? "asc";  // asc | desc

    // 箭頭
    string idArrow = sortBy == "id" ? (sortDir == "asc" ? "▲" : "▼") : "";
    string roleArrow = sortBy == "role" ? (sortDir == "asc" ? "▲" : "▼") : "";

    // 下次點擊的方向
    string nextIdDir = (sortBy == "id" && sortDir == "asc") ? "desc" : "asc";
    string nextRoleDir = (sortBy == "role" && sortDir == "asc") ? "desc" : "asc";
}

<h2 class="mb-3">@ViewData["Title"]</h2>

<!-- 搜尋（GET） -->
<form method="get" class="mb-3">
    <div class="row g-2 align-items-end">
        <div class="col-auto">
            <label for="managerId" class="form-label">管理者編號</label>
            <input id="managerId" name="managerId" type="number" class="form-control"
                   value="@(currentId?.ToString() ?? "")" placeholder="例如：30000001" />
        </div>
        <div class="col-auto">
            <label for="managerName" class="form-label">管理者姓名</label>
            <input id="managerName" name="managerName" type="text" class="form-control"
                   value="@(currentName ?? "")" placeholder="關鍵字" />
        </div>
        <div class="col-auto">
            <label for="roleName" class="form-label">角色名稱</label>
            <input id="roleName" name="roleName" type="text" class="form-control"
                   value="@(currentRole ?? "")" placeholder="關鍵字（如：客服、編輯）" />
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-primary">搜尋</button>
            <a asp-action="Index"
               asp-route-sidebar="@sidebar"
               class="btn btn-outline-secondary">清除</a>
        </div>
    </div>

    <!-- 保留排序與側欄 -->
    <input type="hidden" name="sortBy" value="@sortBy" />
    <input type="hidden" name="sortDir" value="@sortDir" />
    <input type="hidden" name="sidebar" value="@sidebar" />
</form>

@if (Model == null || !Model.Any())
{
    <div class="alert alert-info">目前沒有資料。</div>
}
else
{
    <table class="table table-striped table-hover align-middle">
        <thead>
            <tr>
                <th>
                    <a asp-action="Index"
                       asp-route-managerId="@(currentId?.ToString())"
                       asp-route-managerName="@currentName"
                       asp-route-roleName="@currentRole"
                       asp-route-sortBy="id"
                       asp-route-sortDir="@nextIdDir"
                       asp-route-sidebar="@sidebar">
                        管理者編號 @idArrow
                    </a>
                </th>
                <th>管理者姓名</th>
                <th>角色編號</th>
                <th>
                    <a asp-action="Index"
                       asp-route-managerId="@(currentId?.ToString())"
                       asp-route-managerName="@currentName"
                       asp-route-roleName="@currentRole"
                       asp-route-sortBy="role"
                       asp-route-sortDir="@nextRoleDir"
                       asp-route-sidebar="@sidebar">
                        角色名稱 @roleArrow
                    </a>
                </th>
                <th style="width:120px;">操作</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var x in Model)
            {
                <tr>
                    <td>@x.ManagerId</td>
                    <td>@x.ManagerName</td>
                    <td>@(x.ManagerRoleId == 0 ? "" : x.ManagerRoleId.ToString())</td>
                    <td>@x.RoleName</td>
                    <td>
                        <a asp-action="Details"
                           asp-route-managerId="@x.ManagerId"
                           asp-route-sidebar="@sidebar"
                           class="btn btn-sm btn-outline-secondary">詳細</a>
                        <a asp-action="Edit"
                           asp-route-managerId="@x.ManagerId"
                           asp-route-sidebar="@sidebar"
                           class="btn btn-sm btn-outline-primary">修改</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
