@* Create / Edit 共用；中文標籤＋驗證；asp-action  *@ 
@*會由呼叫端決定（我們用同一個 Partial，靠 Model.ProductId 是否為 0 決定要打哪個 action）。*@

@model GameSpace.Areas.OnlineStore.ViewModels.ProductInfoFormVM

@if (ViewBag.ModelErrors != null)
{
    <div class="alert alert-danger">
        <ul>
            @foreach (var err in ViewBag.ModelErrors)
            {
                <li><strong>@err.Key</strong>：
                    @foreach (var msg in err.Value)
                    {
                        @msg <br />
                    }
                </li>
            }
        </ul>
    </div>
}

<div class="modal-dialog modal-dialog-centered modal-lg">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">@((Model.ProductId == 0) ? "新增商品" : "編輯商品")</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>

    <form asp-area="OnlineStore" asp-controller="ProductInfoes"
          asp-action="@(Model.ProductId==0 ? "Create" : "Edit")"
          method="post" class="js-ajax-form" id="createEditForm"
          enctype="multipart/form-data">
      @Html.AntiForgeryToken()
      @if (Model.ProductId != 0)
      { <input type="hidden" asp-for="ProductId" /> }

      <div class="modal-body">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

        <div class="row g-3">
          <div class="col-md-6">
            <label asp-for="ProductName" class="form-label"></label>
            <input asp-for="ProductName" class="form-control" />
            <span asp-validation-for="ProductName" class="text-danger small"></span>
          </div>
          <div class="col-md-3">
            <label asp-for="ProductType" class="form-label"></label>
            <select asp-for="ProductType" class="form-select" id="ddlType">
              <option value="game">game（下載）</option>
              <option value="nogame">nogame（周邊）</option>
            </select>
            <span asp-validation-for="ProductType" class="text-danger small"></span>
          </div>
          <div class="col-md-3 form-check pt-4 ms-2">
            <input class="form-check-input" asp-for="IsActive" />
            <label class="form-check-label" asp-for="IsActive"></label>
          </div>

          <div class="col-md-4">
            <label asp-for="Price" class="form-label"></label>
            <input asp-for="Price" class="form-control" />
            <span asp-validation-for="Price" class="text-danger small"></span>
          </div>
          <div class="col-md-4">
            <label asp-for="CurrencyCode" class="form-label"></label>
            <select asp-for="CurrencyCode" class="form-select">
              <option>TWD</option><option>USD</option><option>JPY</option><option>CNY</option>
            </select>
            <span asp-validation-for="CurrencyCode" class="text-danger small"></span>
          </div>
          <div class="col-md-4">
            <label asp-for="ShipmentQuantity" class="form-label"></label>
            <input asp-for="ShipmentQuantity" class="form-control" />
            <div class="form-text">game 請填 0 或留空；nogame 必填≥0</div>
            <span asp-validation-for="ShipmentQuantity" class="text-danger small"></span>
          </div>

          <div class="col-12">
            <hr class="my-2" />
            <h6 class="mb-2">Detail</h6>
          </div>

          <!-- 共用 -->
          <div class="col-md-4">
            <label asp-for="SupplierIds" class="form-label"></label>
            <input asp-for="SupplierIds" class="form-control" />
            <span asp-validation-for="SupplierIds" class="text-danger small"></span>
          </div>

          <!-- game 區塊 -->
          <div id="sec-game" class="row g-3">
            <div class="col-md-4">
              <label asp-for="PlatformId" class="form-label"></label>
              <input asp-for="PlatformId" class="form-control" />
              <span asp-validation-for="PlatformId" class="text-danger small"></span>
            </div>
            <div class="col-md-4">
              <label asp-for="PlatformName" class="form-label"></label>
              <input asp-for="PlatformName" class="form-control" />
              <span asp-validation-for="PlatformName" class="text-danger small"></span>
            </div>
            <div class="col-md-4">
              <label asp-for="GameType" class="form-label"></label>
              <input asp-for="GameType" class="form-control" />
            </div>
            <div class="col-12">
              <label asp-for="DownloadLink" class="form-label"></label>
              <input asp-for="DownloadLink" class="form-control" />
              <span asp-validation-for="DownloadLink" class="text-danger small"></span>
            </div>
          </div>

          <!-- nogame 區塊 -->
          <div id="sec-nogame" class="row g-3">
            <div class="col-md-4">
              <label asp-for="MerchTypeId" class="form-label"></label>
              <input asp-for="MerchTypeId" class="form-control" />
            </div>
            <div class="col-md-4">
              <label asp-for="DigitalCode" class="form-label"></label>
              <input asp-for="DigitalCode" class="form-control" />
            </div>
            <div class="col-md-4">
              <label asp-for="Size" class="form-label"></label>
              <input asp-for="Size" class="form-control" />
            </div>
            <div class="col-md-4">
              <label asp-for="Color" class="form-label"></label>
              <input asp-for="Color" class="form-control" />
            </div>
            <div class="col-md-4">
              <label asp-for="Weight" class="form-label"></label>
              <input asp-for="Weight" class="form-control" />
            </div>
            <div class="col-md-4">
              <label asp-for="Dimensions" class="form-label"></label>
              <input asp-for="Dimensions" class="form-control" />
            </div>
            <div class="col-md-4">
              <label asp-for="Material" class="form-label"></label>
              <input asp-for="Material" class="form-control" />
            </div>
            <div class="col-md-4">
              <label asp-for="StockQuantity" class="form-label"></label>
              <input asp-for="StockQuantity" class="form-control" />
              <span class="form-text">預設會帶 ShipmentQuantity</span>
            </div>
          </div>

          <input asp-for="Image" type="file" class="form-control" multiple accept="image/*" />
          <div class="col-12">
            <hr class="my-2" />
            <label class="form-label">商品圖片（可多選上傳）</label>
            <input type="file" name="Images" class="form-control" multiple accept="image/*" />
          </div>

          @* 編輯時顯示舊圖與勾選刪除 *@
          @if (Model.ProductId != 0 && Model.ExistingImages?.Any() == true)
          {
              <div class="col-12">
                <div class="row g-2">
                  @for (int i = 0; i < Model.ExistingImages.Count; i++)
                  {
                      <div class="col-md-3">
                        <div class="card">
                          <img src="@Model.ExistingImages[i].Url" class="card-img-top" alt="@Model.ExistingImages[i].Alt" />
                          <div class="card-body p-2">
                            <input type="hidden" name="ExistingImages[@i].ImageId" value="@Model.ExistingImages[i].ImageId" />
                            <input type="hidden" name="ExistingImages[@i].Url" value="@Model.ExistingImages[i].Url" />
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="ExistingImages[@i].Remove" id="imgrm_@i" />
                              <label for="imgrm_@i" class="form-check-label small">刪除此圖片</label>
                            </div>
                          </div>
                        </div>
                      </div>
                  }
                </div>
              </div>
          }

          @if (Model.ProductId != 0)
          {
            <div class="small text-muted">
              建立：@Model.ProductCreatedAt?.ToString("yyyy/MM/dd HH:mm")（@Model.ProductCreatedBy）<br />
              更新：@Model.ProductUpdatedAt?.ToString("yyyy/MM/dd HH:mm")（@Model.ProductUpdatedBy）
            </div>
          }
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
        <button type="submit" class="btn btn-primary">儲存</button>
      </div>
    </form>

    <partial name="_ValidationScriptsPartial" />
  </div>
</div>

@section Scripts{
<script>
(function(){
  const ddl = document.getElementById('ddlType');
  const g = document.getElementById('sec-game');
  const n = document.getElementById('sec-nogame');
  function toggle(){
    const t = ddl.value;
    g.style.display = (t === 'game') ? '' : 'none';
    n.style.display = (t === 'nogame') ? '' : 'none';
  }
  ddl?.addEventListener('change', toggle);
  toggle();
})();
</script>
}

