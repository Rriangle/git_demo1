@model IEnumerable<GameSpace.Areas.OnlineStore.ViewModels.ProductIndexRowVM>
@{
    var keyword = (string)(ViewBag.Keyword ?? "");
    var currentType = (string?)ViewBag.Type;
    int? qtyMin = (int?)ViewBag.QtyMin;
    int? qtyMax = (int?)ViewBag.QtyMax;
    var status = (string)(ViewBag.Status ?? "active");
    var createdFrom = (string?)ViewBag.CreatedFrom;
    var createdTo = (string?)ViewBag.CreatedTo;
    var hasLog = (string?)ViewBag.HasLog;
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <style>
        .link-quiet {
            color: var(--bs-primary);
            text-decoration: none
        }

            .link-quiet:hover {
                text-decoration: underline
            }

        .action-icons a {
            margin-left: .4rem;
            font-size: 1.1rem
        }

        div.dataTables_wrapper div.dataTables_paginate ul.pagination {
            justify-content: center
        }

        .pagination .page-link {
            padding: .5rem .9rem
        }

        .toast-container-center {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1080
        }
    </style>
}

<h2 class="mb-3">商品清單</h2>

<form method="get" class="row g-2 mb-3">
    <div class="col-md-3">
        <input class="form-control" name="keyword" value="@keyword" placeholder="名稱/類別 關鍵字" />
    </div>
    <div class="col-md-2">
        <select class="form-select" name="type">
            <option value="">全部類別</option>
            @foreach (var t in (IEnumerable<string>)ViewBag.TypeList)
            {
                <option value="@t" selected="@(currentType == t ? "selected" : null)">@t</option>
            }
        </select>
    </div>
    <div class="col-md-2">
        <div class="input-group">
            <span class="input-group-text">存量</span>
            <input type="number" class="form-control" name="qtyMin" value="@(qtyMin?.ToString() ?? "")" placeholder="最小" />
            <span class="input-group-text">~</span>
            <input type="number" class="form-control" name="qtyMax" value="@(qtyMax?.ToString() ?? "")" placeholder="最大" />
        </div>
    </div>
    <div class="col-md-2">
        <select class="form-select" name="status">
            <option value="active" selected="@(status == "active" ? "selected" : null)">上架</option>
            <option value="inactive" selected="@(status == "inactive" ? "selected" : null)">下架</option>
            <option value="all" selected="@(status == "all" ? "selected" : null)">全部</option>
        </select>
    </div>
    <div class="col-md-3">
        <div class="input-group">
            <span class="input-group-text">建立日期</span>
            <input type="date" class="form-control" name="createdFrom" value="@createdFrom" />
            <span class="input-group-text">~</span>
            <input type="date" class="form-control" name="createdTo" value="@createdTo" />
        </div>
    </div>
    <div class="col-md-3">
        <select class="form-select" name="hasLog">
            <option value="" selected="@(string.IsNullOrEmpty(hasLog) ? "selected" : null)">異動紀錄(全部)</option>
            <option value="yes" selected="@(hasLog == "yes" ? "selected" : null)">有異動</option>
            <option value="no" selected="@(hasLog == "no" ? "selected" : null)">無異動</option>
        </select>
    </div>

    <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">套用條件</button></div>
    <div class="col-md-2">
        <!-- ★ 改為 reset + 手動 submit，保證網址參數清空 -->
        <button type="reset" id="btnClearFilters" class="btn btn-outline-secondary w-100">
            <i class="bi bi-eraser"></i> 清除條件
        </button>
    </div>
    <div class="col-md-5 d-flex justify-content-end">
        <a href="javascript:;" class="btn btn-primary"
           data-modal-url="@Url.Action("Create", "ProductInfoes", new { area = "OnlineStore" })">
            <i class="bi bi-plus-circle-fill me-1"></i> 新增商品
        </a>
    </div>

    <div class="d-flex justify-content-end">
        <button id="btnToggleView" type="button" class="btn btn-outline-secondary">
            <i class="bi bi-grid-3x3-gap"></i> 卡片檢視
        </button>
    </div>
</form>

<!-- ★ 表格要放在 listHost，切換卡片時才會隱藏 -->
<div id="listHost">
    <table id="productTable" class="table table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th style="width:90px;">商品ID</th>
                <th>名稱</th>
                <th>類別</th>
                <th class="text-end">價格</th>
                <th class="text-center">存量</th>
                <th class="text-center">狀態</th>
                <th>建立時間</th>
                <th>最後異動</th>
                <th class="text-end">操作功能</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var x in Model)
            {
                <tr data-id="@x.ProductId">
                    <td>#@x.ProductId</td>
                    <td>@x.ProductName</td>
                    <td>@x.ProductType</td>
                    <td class="text-end">@x.Price.ToString("N0")</td>
                    <td class="text-center">@x.ShipmentQuantity</td>
                    <td class="text-center js-active-cell">
                        @if (x.IsActive)
                        {
                            <span class="badge bg-success">上架</span>
                        }
                        else
                        {

                            <span class="badge bg-secondary">下架</span>
                        }
                    </td>
                    <td>
                        <a href="#" class="link-quiet"
                           data-bs-toggle="modal" data-bs-target="#createdModal"
                           data-created="@x.ProductCreatedAt.ToString("yyyy/MM/dd HH:mm:ss")"
                           data-manager="@x.CreatedByManagerId">
                            @x.ProductCreatedAt.ToString("yyyy/MM/dd tt hh:mm")
                        </a>
                    </td>
                    <td>
                        @if (x.LastLog is not null)
                        {
                            <a href="#" class="link-quiet"
                               data-bs-toggle="modal" data-bs-target="#lastLogModal"
                               data-changed="@x.LastLog.ChangedAt.ToString("yyyy/MM/dd HH:mm:ss")"
                               data-manager="@x.LastLog.ManagerId">
                                @x.LastLog.ChangedAt.ToString("yyyy/MM/dd tt hh:mm")
                            </a>
                        }
                        else
                        {

                            <span class="text-muted small">—</span>
                        }
                    </td>
                    <td class="text-end action-icons">
                        <a href="javascript:;" class="text-info" title="詳細"
                           data-modal-url="@Url.Action("Details", "ProductInfoes", new { area = "OnlineStore", id = x.ProductId })">
                            <i class="bi bi-card-text"></i>
                        </a>
                        <a href="javascript:;" class="text-primary" title="編輯"
                           data-modal-url="@Url.Action("Edit", "ProductInfoes", new { area = "OnlineStore", id = x.ProductId })">
                            <i class="bi bi-pencil-square"></i>
                        </a>
                        <a href="javascript:;" class="text-danger" title="下架（軟刪）"
                           data-modal-url="@Url.Action("Delete", "ProductInfoes", new { area = "OnlineStore", id = x.ProductId })">
                            <!-- ★ 改成 id -->
                            <i class="bi bi-trash"></i>
                        </a>
                        <a href="javascript:;" class="text-secondary" title="異動紀錄"
                           data-modal-url="@Url.Action("AuditLog", "ProductInfoes", new { area = "OnlineStore", id = x.ProductId })">
                            <i class="bi bi-clock-history"></i>
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- 卡片檢視容器 -->
<div id="cardsHost" class="d-none"></div>

<!-- Anti-Forgery Token（AJAX 用） -->
<form id="__af" method="post">@Html.AntiForgeryToken()</form>

<!-- 通用 Modal -->
<div class="modal fade" id="modalHost" tabindex="-1" aria-hidden="true"></div>

<!-- 建立/最後異動兩個小 Modal -->
<div class="modal fade" id="createdModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">建立資訊</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <p><strong>建立時間：</strong><span id="createdAt"></span></p>
                <p><strong>建立人：</strong><span id="createdBy"></span></p>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="lastLogModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">最後異動資訊</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <p><strong>最後異動時間：</strong><span id="lastChangedAt"></span></p>
                <p><strong>異動人：</strong><span id="lastChangedBy"></span></p>
            </div>
        </div>
    </div>
</div>

<div class="toast-container-center">
    <div id="mainToast" class="toast align-items-center text-white bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="mainToastBody">已完成</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

@section Scripts {
    <!-- ★ 必須：Bootstrap JS（Modal/Tooltip 需要） -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- jQuery & DataTables -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        (() => {
          // 1) DataTables 初始化
          const dt = $('#productTable').DataTable({
            searching: false, ordering: true,
            order: [[0,'desc']],              // ★ 0 欄（#商品ID）預設降冪
            pageLength: 10,
            lengthMenu: [[10,20,30,50,100,-1],[10,20,30,50,100,'全部']],
            language: {
              emptyTable: "沒有資料",
              info: "第 _PAGE_ 頁，共 _PAGES_ 頁（共 _TOTAL_ 筆）",
              infoEmpty: "顯示第 0 到 0 筆，共 0 筆",
              infoFiltered: "(從 _MAX_ 筆資料過濾)",
              lengthMenu: "每頁顯示 _MENU_ 筆",
              loadingRecords: "載入中...", processing: "處理中...",
              search: "快速搜尋：", zeroRecords: "查無符合資料",
              paginate: { first:"第一頁", last:"最後一頁", next:"下一頁", previous:"上一頁" },
              aria: { sortAscending:": 以遞增排序此欄", sortDescending:": 以遞減排序此欄" }
            },
            columnDefs: [
              { targets: -1, orderable: false } // 最後一欄「操作功能」不排序
            ]
          });

          // 2) 清除篩選（reset + submit）
          document.getElementById('btnClearFilters')?.addEventListener('click', (e) => {
            e.preventDefault();
            const form = document.querySelector('form[method="get"]');
            if (!form) return;
            form.reset();
            form.submit();
          });

          // 3) 小 Modal 值帶入
          document.getElementById('createdModal')?.addEventListener('show.bs.modal', (e) => {
            const a = e.relatedTarget; if (!a) return;
            document.getElementById('createdAt').textContent = a.getAttribute('data-created') ?? '-';
            document.getElementById('createdBy').textContent = a.getAttribute('data-manager') ?? '-';
          });
          document.getElementById('lastLogModal')?.addEventListener('show.bs.modal', (e) => {
            const a = e.relatedTarget; if (!a) return;
            document.getElementById('lastChangedAt').textContent = a.getAttribute('data-changed') ?? '-';
            document.getElementById('lastChangedBy').textContent = a.getAttribute('data-manager') ?? '-';
          });

          // 4) 通用載入 Partial 作為 Modal（Create/Edit/Details/Delete/AuditLog）
          document.addEventListener('click', async (ev) => {
            const a = ev.target.closest('[data-modal-url]');
            if (!a) return;
            ev.preventDefault();

            const url  = a.getAttribute('data-modal-url');
            const res  = await fetch(url, { credentials: 'include' });
            const html = await res.text();
            const host = document.getElementById('modalHost');
            host.innerHTML = html;

            // unobtrusive 驗證：動態載入的表單要 parse
            if (window.jQuery && $.validator && $.validator.unobtrusive) {
              $.validator.unobtrusive.parse($('#modalHost'));
            }

            new bootstrap.Modal(host).show();

            // 綁 AJAX 表單提交（Create/Edit/Delete）
            host.querySelectorAll('form.js-ajax-form').forEach(f => f.addEventListener('submit', submitAjaxOnce));
          });

          // 5) Toast 小工具
          const showToast = (msg, ok = true) => {
            const el = document.getElementById('mainToast');
            const body = document.getElementById('mainToastBody');
            body.textContent = msg || (ok ? '已完成' : '處理失敗');
            el.classList.toggle('bg-success', ok);
            el.classList.toggle('bg-danger', !ok);
            new bootstrap.Toast(el, { delay: 1800 }).show();
          };

          // 6) 提交 Partial 內表單的 AJAX
          const submitAjaxOnce = async (ev) => {
            ev.preventDefault();
            const form = ev.currentTarget;
            form.removeEventListener('submit', submitAjaxOnce); // once：避免重複

            const formData = new FormData(form);
            const res = await fetch(form.action, { method: 'POST', body: formData, credentials: 'include' });
            const ct = res.headers.get('content-type') || '';

            if (ct.includes('application/json')) {
              const json = await res.json();
              showToast(json.msg || '已完成', json.ok);
              if (!json.ok) return;

              // Edit：不重整，直接更新該列
              if (json.updated) {
                const u = json.updated;
                const tr = document.querySelector(`tr[data-id="${u.id}"]`);
                if (tr) {
                  tr.children[1].textContent = u.name;
                  tr.children[2].textContent = u.type;
                  tr.children[3].textContent = u.priceN0;
                  tr.children[4].textContent = (u.qty ?? '');
                  tr.querySelector('.js-active-cell').innerHTML = u.active
                    ? '<span class="badge bg-success">上架</span>'
                    : '<span class="badge bg-secondary">下架</span>';

                  tr.children[7].innerHTML =
                    `<a href="#" class="link-quiet" data-bs-toggle="modal" data-bs-target="#lastLogModal"
                        data-changed="${u.lastChangedRaw}" data-manager="${u.lastManagerId}">
                        ${u.lastChangedText}
                     </a>`;

                  dt.row(tr).invalidate().draw(false); // 告訴 DataTables 這列更新了
                }
                bootstrap.Modal.getInstance(document.getElementById('modalHost'))?.hide();
                return;
              }

              // Create / Delete：簡單用重整最穩
              setTimeout(() => location.reload(), 900);
            } else {
              // 驗證失敗：回傳新的表單 HTML
              const html = await res.text();
              const host = document.getElementById('modalHost');
              host.innerHTML = html;
              host.querySelectorAll('form.js-ajax-form').forEach(f => f.addEventListener('submit', submitAjaxOnce));
              if (window.jQuery && $.validator && $.validator.unobtrusive) {
                $.validator.unobtrusive.parse($('#modalHost'));
              }
            }
          };

          // 7) 卡片檢視切換
          (() => {
            const btn = document.getElementById('btnToggleView');
            const listHost  = document.getElementById('listHost');
            const cardsHost = document.getElementById('cardsHost');
            let cardsLoaded = false;

            btn?.addEventListener('click', async () => {
              if (cardsHost.classList.contains('d-none')) {
                // 顯示卡片
                if (!cardsLoaded) {
                  const url = '@Url.Action("Cards", "ProductInfoes", new { area = "OnlineStore" })';
                  const res = await fetch(url, { credentials: 'include' });
                  cardsHost.innerHTML = await res.text();
                  cardsLoaded = true;
                }
                listHost.classList.add('d-none');
                cardsHost.classList.remove('d-none');
                btn.innerHTML = '<i class="bi bi-list"></i> 表格檢視';
              } else {
                // 顯示表格
                cardsHost.classList.add('d-none');
                listHost.classList.remove('d-none');
                btn.innerHTML = '<i class="bi bi-grid-3x3-gap"></i> 卡片檢視';
              }
            });
          })();
        })();
    </script>
}



<!--
@*@model IEnumerable<GameSpace.Areas.OnlineStore.ViewModels.ProductIndexRowVM>
@{
    var keyword = (string)(ViewBag.Keyword ?? "");
    var currentType = (string?)ViewBag.Type;
    int? qtyMin = (int?)ViewBag.QtyMin;
    int? qtyMax = (int?)ViewBag.QtyMax;
    var status = (string)(ViewBag.Status ?? "active");
    var createdFrom = (string?)ViewBag.CreatedFrom;
    var createdTo = (string?)ViewBag.CreatedTo;
    var hasLog = (string?)ViewBag.HasLog;

}


@section Styles {
    <!-- Bootstrap Icons& DataTables -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- DataTables (Bootstrap5) -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <style>
        /* 漂亮一點的可點連結 */
        .link-quiet {
            color: var(--bs-primary);
            text-decoration: none;
        }

            .link-quiet:hover {
                text-decoration: underline;
            }

        /* 操作列圖示間距 */
        .action-icons a {
            margin-left: .4rem;
            font-size: 1.1rem;
        }

        /* DataTables 分頁置中 & 稍微加大 */
        div.dataTables_wrapper div.dataTables_paginate ul.pagination {
            justify-content: center;
        }

        .pagination .page-link {
            padding: .5rem .9rem;
        }

        /* 上方 length 與 info 排版 */
        div.dataTables_wrapper .dt-top {
            margin-bottom: .5rem;
        }

        .link-quiet {
            color: var(--bs-primary);
            text-decoration: none;
        }

            .link-quiet:hover {
                text-decoration: underline;
            }

        .action-icons a {
            margin-left: .4rem;
            font-size: 1.1rem;
        }

        /* div.dataTables_wrapper div.dataTables_paginate ul.pagination {
                                                    justify-content: center;
                                                } */

        .pagination .page-link {
            padding: .5rem .9rem;
        }

        .toolbar {
            display: flex;
            gap: .5rem;
            justify-content: flex-end;
            margin-bottom: .5rem;
        }

        .toast-container-center {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1080;
        }

    </style>
}

<h2 class="mb-3">商品清單</h2>

<!-- 🔎 篩選列 -->
<form method="get" class="row g-2 mb-3">
    <div class="col-md-3">
        <input class="form-control" name="keyword" value="@keyword" placeholder="名稱/類別 關鍵字" />
    </div>

    <div class="col-md-2">
        <select class="form-select" name="type">
            <option value="">全部類別</option>
            @foreach (var t in (IEnumerable<string>)ViewBag.TypeList)
            {
                <option value="@t" selected="@(currentType == t ? "selected" : null)">@t</option>
            }
        </select>
    </div>

    <div class="col-md-2">
        <div class="input-group">
            <span class="input-group-text">存量</span>
            <input type="number" class="form-control" name="qtyMin" value="@(qtyMin?.ToString() ?? "")" placeholder="最小" />
            <span class="input-group-text">~</span>
            <input type="number" class="form-control" name="qtyMax" value="@(qtyMax?.ToString() ?? "")" placeholder="最大" />
        </div>
    </div>

    <div class="col-md-2">
        <select class="form-select" name="status">
            <span class="input-group-text">狀態</span>
            <option value="active" selected="@(status == "active" ? "selected" : null)">上架</option>
            <option value="inactive" selected="@(status == "inactive" ? "selected" : null)">下架</option>
            <option value="all" selected="@(status == "all" ? "selected" : null)">全部</option>
        </select>
    </div>

    <div class="col-md-3">
        <div class="input-group">
            <span class="input-group-text">建立日期</span>
            <input type="date" class="form-control" name="createdFrom" value="@createdFrom" />
            <span class="input-group-text">~</span>
            <input type="date" class="form-control" name="createdTo" value="@createdTo" />
        </div>
    </div>

    <div class="col-md-3">
        <select class="form-select" name="hasLog">
            <option value="" selected="@(string.IsNullOrEmpty(hasLog) ? "selected" : null)">異動紀錄(全部)</option>
            <option value="yes" selected="@(hasLog == "yes" ? "selected" : null)">有異動</option>
            <option value="no" selected="@(hasLog == "no" ? "selected" : null)">無異動</option>
        </select>
    </div>

    <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">套用條件</button>
    </div>

    <div class="col-md-2">
        <!-- 一鍵清除（JS 會清空表單並提交） -->
        <button type="reset" id="btnClearFilters" class="btn btn-outline-secondary w-100">
            <i class="bi bi-eraser"></i> 清除條件
        </button>
    </div>


    <div class="toolbar col-md-8 d-flex justify-content-end">
        <!-- 可愛一點的新增 ICON：星星+加號 -->
        <a href="javascript:;" class="btn btn-primary"
           data-modal-url="@Url.Action("Create", "ProductInfoes", new { area = "OnlineStore" })">
            <i class="bi"></i><i class="bi bi-plus-circle-fill"></i> 新增商品
        </a>
    </div>


</form>

<!-- 📋 表格：交給 DataTables 分頁/排序/每頁筆數 -->
<table id="productTable" class="table table-hover align-middle">
    <thead class="table-light">
        <tr>
            <th style="width:90px;">商品ID</th>
            <th>名稱</th>
            <th>類別</th>
            <th class="text-end">價格</th>
            <th class="text-center">存量</th>
            <th class="text-center">狀態</th>
            <th>建立時間</th>
            <th>最後異動</th>
            <th class="text-end">操作功能</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var x in Model)
        {
            <tr data-id="@x.ProductId">
                <td>#@x.ProductId</td>

                <td>@x.ProductName</td>
                <td>@x.ProductType</td>
                <td class="text-end">@x.Price.ToString("N0")</td>
                <td class="text-center">@x.ShipmentQuantity</td>

                <!-- ✅ 狀態格加 js-active-cell，讓切換後能即時更新 -->
                <td class="text-center js-active-cell">
                    @if (x.IsActive)
                    {
                        <span class="badge bg-success">上架</span>
                    }
                    else
                    {

                        <span class="badge bg-secondary">下架</span>
                    }
                </td>
                <td>
                    <a href="#" class="link-quiet"
                       data-bs-toggle="modal" data-bs-target="#createdModal"
                       data-created="@x.ProductCreatedAt.ToString("yyyy/MM/dd HH:mm:ss")"
                       data-manager="@x.CreatedByManagerId">
                        @x.ProductCreatedAt.ToString("yyyy/MM/dd tt hh:mm")
                    </a>
                </td>
                <td>
                    @if (x.LastLog is not null)
                    {
                        <a href="#" class="link-quiet"
                           data-bs-toggle="modal" data-bs-target="#lastLogModal"
                           data-changed="@x.LastLog.ChangedAt.ToString("yyyy/MM/dd HH:mm:ss")"
                           data-manager="@x.LastLog.ManagerId">
                            @x.LastLog.ChangedAt.ToString("yyyy/MM/dd tt hh:mm")
                        </a>
                    }
                    else
                    {

                        <span class="text-muted small">—</span>
                    }
                </td>
                <td class="text-end action-icons">
                    @* <!-- 切換上/下架（JS AJAX） -->
                    @if (x.IsActive)
                    {
                        <a href="javascript:;" class="text-warning js-toggle-active" title="下架（切換）">
                            <i class="bi bi-toggle-on"></i>
                        </a>
                    }
                    else
                    {
                        <a href="javascript:;" class="text-success js-toggle-active" title="上架（切換）">
                            <i class="bi bi-toggle-off"></i>
                        </a>
                    } 

                    <!-- 詳細 / 編輯 / 軟刪（下架） / 異動紀錄 → Modal（JS AJAX 載入 Partial） -->
                    <a href="javascript:;" class="text-info" title="詳細"
                       data-modal-url="@Url.Action("Details", "ProductInfoes", new { area = "OnlineStore", id = x.ProductId })">
                        <i class="bi bi-card-text"></i>
                    </a>
                    <a href="javascript:;" class="text-primary" title="編輯"
                       data-modal-url="@Url.Action("Edit", "ProductInfoes", new { area = "OnlineStore", id = x.ProductId })">
                        <i class="bi bi-pencil-square"></i>
                    </a>
                    <a href="javascript:;" class="text-danger" title="下架（軟刪）"
                       data-modal-url="@Url.Action("Delete", "ProductInfoes", new { area = "OnlineStore", id = x.ProductId })">
                        <i class="bi bi-trash"></i>
                    </a>
                    <a href="javascript:;" class="text-secondary" title="異動紀錄"
                       data-modal-url="@Url.Action("AuditLog", "ProductInfoes", new { area = "OnlineStore", id = x.ProductId })">
                        <i class="bi bi-clock-history"></i>
                    </a>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- Anti-Forgery Token（AJAX 用） -->
<form id="__af" method="post">@Html.AntiForgeryToken()</form>

<!-- 通用 Modal 容器（⚠️ 僅保留一個，不要重複宣告） -->
<div class="modal fade" id="modalHost" tabindex="-1" aria-hidden="true"></div>

<!-- 🪟 建立資訊 Modal（置中） -->
<div class="modal fade" id="createdModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">建立資訊</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>建立時間：</strong><span id="createdAt"></span></p>
                <p><strong>建立人：</strong><span id="createdBy"></span></p>
            </div>
        </div>
    </div>
</div>

<!-- 🪟 最後異動 Modal（置中） -->
<div class="modal fade" id="lastLogModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">最後異動資訊</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>最後異動時間：</strong><span id="lastChangedAt"></span></p>
                <p><strong>異動人：</strong><span id="lastChangedBy"></span></p>
            </div>
        </div>
    </div>
</div>

<!-- 異動成功 Toast -->
<div class="toast-container-center">
    <div id="mainToast" class="toast align-items-center text-white bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="mainToastBody">已完成</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>


@section Scripts {
    <!-- jQuery & DataTables -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
   (function(){
    // DataTables 初始化（前端分頁/排序；圖示小三角由 DataTables CSS 提供）
            $('#productTable').DataTable({
            searching: false,
            ordering:  true,
            order: [[0, 'desc']],   // 改成依「商品ID」降冪
            pageLength: 10,
            lengthMenu: [[10,20,50,100,-1],[10,20,50,100,'全部']],
            language: {
                info: "第 _PAGE_ 頁，共 _PAGES_ 頁（共 _TOTAL_ 筆）",
                lengthMenu: "每頁顯示 _MENU_ 筆",
                paginate: { first:"第一頁", last:"最後一頁", next:"下一頁", previous:"上一頁" }
            },
            columnDefs: [
                { targets: -1, orderable: false }   // 功能欄位不排序
            ]
        });

                  // Bootstrap Tooltip（小提示）
                  if (window.bootstrap) {
                    document.querySelectorAll('[title]').forEach(el => { new bootstrap.Tooltip(el); });
                  }

                  // 一鍵清除（前端清空 & 提交） // JS
                  document.getElementById('btnClearFilters')?.addEventListener('click', () => {
                    const form = document.querySelector('form[method="get"]');
                    if (!form) return;
                    form.querySelectorAll('input[type="text"], input[type="number"], input[type="date"]').forEach(i => i.value = '');
                    form.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
                    form.submit();
                  });

                  // 建立/最後異動 Modal 值帶入 // JS
                  const createdModal = document.getElementById('createdModal');
                  createdModal?.addEventListener('show.bs.modal', (e) => {
                    const link = e.relatedTarget;
                    document.getElementById('createdAt').textContent = link.getAttribute('data-created') ?? '-';
                    document.getElementById('createdBy').textContent = link.getAttribute('data-manager') ?? '-';
                  });
                  const lastLogModal = document.getElementById('lastLogModal');
                  lastLogModal?.addEventListener('show.bs.modal', (e) => {
                    const link = e.relatedTarget;
                    document.getElementById('lastChangedAt').textContent = link.getAttribute('data-changed') ?? '-';
                    document.getElementById('lastChangedBy').textContent = link.getAttribute('data-manager') ?? '-';
                  });

                  // 通用載入 Partial 作為 Modal（Create/Edit/Details/Delete/AuditLog） // JS + AJAX
                  document.addEventListener('click', async (e) => {
                    const a = e.target.closest('[data-modal-url]');
                    if (!a) return;
                    e.preventDefault();
                    const url = a.getAttribute('data-modal-url');
                    const res = await fetch(url, { credentials: 'include' });
                    const html = await res.text();
                    const host = document.getElementById('modalHost');
                    host.innerHTML = html;
                    // 解析 unobtrusive 驗證（AJAX 載入的表單一定要呼叫）
                    //讓 jQuery 驗證在 Modal 裡生效
                    if (window.jQuery && $.validator && $.validator.unobtrusive) {
                    $.validator.unobtrusive.parse($('#modalHost'));
                    }

                    new bootstrap.Modal(host).show();

                    // 綁 AJAX 表單提交（Create/Edit/Delete）
                    host.querySelectorAll('form.js-ajax-form').forEach(form => {
                      form.addEventListener('submit', submitAjaxOnce);
                  });


                  // 切換上/下架（不重整即時更新） // JS + AJAX
                  document.addEventListener('click', async (e) => {
                    const btn = e.target.closest('.js-toggle-active');
                    if (!btn) return;
                    e.preventDefault();

                    const tr = btn.closest('tr');
                    const id = tr?.getAttribute('data-id');
                    if (!id) return;

                    const token = document.querySelector('#__af input[name="__RequestVerificationToken"]').value;
                    const url = '@Url.Action("ToggleActive", "ProductInfoes", new { area = "OnlineStore" })';

                    const res = await fetch(url, {
                      method: 'POST',
                      headers: { 'RequestVerificationToken': token, 'Content-Type': 'application/x-www-form-urlencoded' },
                      body: new URLSearchParams({ id })
                    });

                    const ct = res.headers.get('content-type') || '';
                    if (!ct.includes('application/json')) return location.reload();

                    const json = await res.json();
                    showToast(json.msg || '狀態已切換', json.ok);

                    // UI 即時更新：徽章與圖示
                    const cell = tr.querySelector('.js-active-cell');
                    if (json.active) {
                      cell.innerHTML = '<span class="badge bg-success">上架</span>';
                      btn.classList.remove('text-success'); btn.classList.add('text-warning');
                      btn.innerHTML = '<i class="bi bi-toggle-on"></i>';
                      btn.setAttribute('title', '下架（切換）');
                    } else {
                      cell.innerHTML = '<span class="badge bg-secondary">下架</span>';
                      btn.classList.remove('text-warning'); btn.classList.add('text-success');
                      btn.innerHTML = '<i class="bi bi-toggle-off"></i>';
                      btn.setAttribute('title', '上架（切換）');
                    }
                  });

                  // Toast helper // JS
                  function showToast(msg, ok=true){
                    const toastEl = document.getElementById('mainToast');
                    const body = document.getElementById('mainToastBody');
                    body.textContent = msg || (ok ? '已完成' : '處理失敗');
                    toastEl.classList.toggle('bg-success', ok);
                    toastEl.classList.toggle('bg-danger', !ok);
                    new bootstrap.Toast(toastEl, { delay: 1800 }).show();
                  }

                 // Partial 裡的表單 AJAX 提交（Create/Edit/Delete） // JS + AJAX
                  async function submitAjaxOnce(ev){
                  ev.preventDefault();
                  const form = ev.currentTarget;
                  form.removeEventListener('submit', submitAjaxOnce); // once
                  const formData = new FormData(form);
                  const res = await fetch(form.action, { method:'POST', body:formData, credentials:'include' });
                  const ct = res.headers.get('content-type') || '';

                  if (ct.includes('application/json')) {
                    const json = await res.json();
                    showToast(json.msg || '已完成', json.ok);
                    if (!json.ok) return;

                    // ✅ 有 updated 代表是 Edit 成功 → 不重整，直接更新該列
                    if (json.updated) {
                      const u  = json.updated;
                      const tr = document.querySelector(`tr[data-id="${u.id}"]`);
                      if (tr) {
                        const table = $('#productTable').DataTable();

                        // 對應 9 欄位：0#ID,1名稱,2類別,3價格,4存量,5狀態,6建立時間(不動),7最後異動,8功能(不動)
                        // 1) 名稱 / 類別 / 價格 / 存量
                        tr.children[1].textContent = u.name;
                        tr.children[2].textContent = u.type;
                        tr.children[3].textContent = u.priceN0;
                        tr.children[4].textContent = (u.qty ?? '');

                        // 2) 狀態徽章
                        const cellStatus = tr.querySelector('.js-active-cell');
                        if (u.active) cellStatus.innerHTML = '<span class="badge bg-success">上架</span>';
                        else          cellStatus.innerHTML = '<span class="badge bg-secondary">下架</span>';

                        // 3) 最後異動欄（用 a 標籤帶 data-* 以便點開彈窗）
                        tr.children[7].innerHTML =
                          `<a href="#" class="link-quiet"
                              data-bs-toggle="modal" data-bs-target="#lastLogModal"
                              data-changed="${u.lastChangedRaw}"
                              data-manager="${u.lastManagerId}">
                              ${u.lastChangedText}
                           </a>`;

                        // 4) 通知 DataTables 這列有更新（不換頁）
                        table.row(tr).invalidate().draw(false);
                      }

                      // 關掉 Modal
                      bootstrap.Modal.getInstance(document.getElementById('modalHost'))?.hide();
                      return; // 不重整
                    }

                    // Create / Delete：先簡單用重整
                    setTimeout(()=> location.reload(), 900);
                  } else {
                    // 驗證失敗：回傳 Partial，替換 modal
                    const html = await res.text();
                    const host = document.getElementById('modalHost');
                    host.innerHTML = html;
                    host.querySelectorAll('form.js-ajax-form').forEach(f => f.addEventListener('submit', submitAjaxOnce));
                  }
                }
                })();
    </script>
} -->



<!-- 沒串AJAX
    <script>
        $(function () {
            // 啟用 Bootstrap tooltip
            $('[data-bs-toggle="tooltip"]').tooltip();

            // DataTables：關閉內建搜尋（我們用上面的後端條件），開啟排序/每頁筆數/中文化
            $('#productTable').DataTable({
                searching: false,
                ordering:  true,
                pageLength: 10,
                lengthMenu: [[10, 20, 50, 100, -1], [10, 20, 50, 100, "全部"]],
                language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json" },
                // 版位：上方左 length、右 info；表格；下方置中分頁
                dom: "<'row dt-top'<'col-sm-6'l><'col-sm-6 text-end'i>>" + "t" +
                     "<'row mt-3'<'col-12'p>>",
                columnDefs: [
                    { targets: -1, orderable: false }, // 操作欄不排序
                ]
            });

            // 建立資訊 modal
            const createdModal = document.getElementById('createdModal');
            createdModal.addEventListener('show.bs.modal', function (event) {
                const link = event.relatedTarget;
                document.getElementById('createdAt').textContent = link.getAttribute('data-created') ?? '-';
                document.getElementById('createdBy').textContent = link.getAttribute('data-manager') ?? '-';
            });

            // 最後異動 modal
            const lastLogModal = document.getElementById('lastLogModal');
            lastLogModal.addEventListener('show.bs.modal', function (event) {
                const link = event.relatedTarget;
                document.getElementById('lastChangedAt').textContent = link.getAttribute('data-changed') ?? '-';
                document.getElementById('lastChangedBy').textContent = link.getAttribute('data-manager') ?? '-';
            });
        });
    </script> -->

<-- @* 2.0改版@{
	var page = (int)(ViewBag.Page ?? 1);
	var pageSize = (int)(ViewBag.PageSize ?? 10);
	var total = (int)(ViewBag.TotalCount ?? 0);
	int lastPage = pageSize > 0 ? (int)Math.Ceiling((double)total / pageSize) : 1;

	string sort = (string)(ViewBag.Sort ?? "created_desc");
	string currentSearch = (string)(ViewBag.Search ?? "");
	string? currentType = (string?)ViewBag.Type;
	string status = (string)(ViewBag.Status ?? "active");
	string? createdFrom = (string?)ViewBag.CreatedFrom;
	string? createdTo = (string?)ViewBag.CreatedTo;
	int? qtyMin = (int?)ViewBag.QtyMin;
	int? qtyMax = (int?)ViewBag.QtyMax;

	// 產生排序用的小工具
	Func<string, string> asc = col => $"{col}_asc";
	Func<string, string> desc = col => $"{col}_desc";
}

<h2 class="mb-3">商品清單</h2>

<!-- 🔎 搜尋 / 篩選 -->
<form method="get" class="row g-2 mb-3">
	<div class="col-md-3">
		<input class="form-control" name="search" value="@currentSearch" placeholder="輸入名稱 / 類別 / 關鍵字" />
	</div>

	<div class="col-md-2">
		<select class="form-select" name="type">
			<span class="input-group-text">類別</span>
			@foreach (var t in (IEnumerable<string>)ViewBag.TypeList)
			{
				<option value="@t" selected="@(ViewBag.Type == t ? "selected" : null)">@t</option>
			}
			<option value="">全部</option>
		</select>
	</div>

	@* <div class="col-md-2">
		<div class="input-group">
			<span class="input-group-text">存量</span>
			<input type="number" class="form-control" name="qtyMin" value="@(qtyMin?.ToString() ?? "")" placeholder="最小" />
			<span class="input-group-text">~</span>
			<input type="number" class="form-control" name="qtyMax" value="@(qtyMax?.ToString() ?? "")" placeholder="最大" />
		</div>
	</div> *@
    @* 	<div class="col-md-2">
		<select class="form-select" name="status">
			<option value="active" selected="@(status == "active" ? "selected" : null)">上架</option>
			<option value="inactive" selected="@(status == "inactive" ? "selected" : null)">下架</option>
			<option value="all" selected="@(status == "all" ? "selected" : null)">全部</option>
		</select>
	</div>

	<div class="col-md-3">
		<div class="input-group">
			<span class="input-group-text">建立時間</span>
			<input type="date" class="form-control" name="createdFrom" value="@createdFrom" />
			<span class="input-group-text">~</span>
			<input type="date" class="form-control" name="createdTo" value="@createdTo" />
		</div>
	</div>

	<div class="col-md-2">
		<select class="form-select" name="hasLog">
			<span class="input-group-text">異動紀錄</span>
			<option value="yes" selected="@(ViewBag.HasLog == "yes" ? "selected" : null)">有異動</option>
			<option value="no" selected="@(ViewBag.HasLog == "no" ? "selected" : null)">無異動</option>
			<option value="">全部</option>
		</select>
	</div>

	<div class="col-md-2">
		<select class="form-select" name="pageSize">
			<option value="10" selected="@(ViewBag.PageSize == 10 ? "selected" : null)">10</option>
			<option value="20" selected="@(ViewBag.PageSize == 20 ? "selected" : null)">20</option>
			<option value="50" selected="@(ViewBag.PageSize == 50 ? "selected" : null)">50</option>
			<option value="100" selected="@(ViewBag.PageSize == 100 ? "selected" : null)">100</option>
			<option value="0" selected="@(ViewBag.PageSize == 0 ? "selected" : null)">全部</option>
		</select>
	</div>

	<div class="col-md-2">
		<button type="submit" class="btn btn-primary w-100">搜尋</button>
	</div>

	<div class="col-12 d-flex gap-2 mt-2">
		<button type="submit" class="btn btn-primary">套用條件</button>
		<a class="btn btn-outline-secondary" asp-action="Index">清除</a>
	</div>
</form>

<!-- 📋 清單 -->
<table class="table table-hover align-middle">
	<thead class="table-light">
		<tr>
			<th>
				名稱
				<a asp-action="Index" asp-route-sort="@asc("name")"
				   asp-route-search="@currentSearch" asp-route-type="@currentType"
				   asp-route-qtyMin="@qtyMin" asp-route-qtyMax="@qtyMax"
				   asp-route-status="@status" asp-route-createdFrom="@createdFrom" asp-route-createdTo="@createdTo"
				   class="ms-1 small">▲</a>
				<a asp-action="Index" asp-route-sort="@desc("name")"
				   asp-route-search="@currentSearch" asp-route-type="@currentType"
				   asp-route-qtyMin="@qtyMin" asp-route-qtyMax="@qtyMax"
				   asp-route-status="@status" asp-route-createdFrom="@createdFrom" asp-route-createdTo="@createdTo"
				   class="small">▼</a>
			</th>
			<th>
				類別
				<a asp-action="Index" asp-route-sort="@asc("type")" asp-route-search="@currentSearch" asp-route-type="@currentType"
				   asp-route-qtyMin="@qtyMin" asp-route-qtyMax="@qtyMax" asp-route-status="@status"
				   asp-route-createdFrom="@createdFrom" asp-route-createdTo="@createdTo" class="ms-1 small">▲</a>
				<a asp-action="Index" asp-route-sort="@desc("type")" asp-route-search="@currentSearch" asp-route-type="@currentType"
				   asp-route-qtyMin="@qtyMin" asp-route-qtyMax="@qtyMax" asp-route-status="@status"
				   asp-route-createdFrom="@createdFrom" asp-route-createdTo="@createdTo" class="small">▼</a>
			</th>
			<th class="text-end">
				價格
				<a asp-action="Index" asp-route-sort="@asc("price")" asp-route-search="@currentSearch" asp-route-type="@currentType"
				   asp-route-qtyMin="@qtyMin" asp-route-qtyMax="@qtyMax" asp-route-status="@status"
				   asp-route-createdFrom="@createdFrom" asp-route-createdTo="@createdTo" class="ms-1 small">▲</a>
				<a asp-action="Index" asp-route-sort="@desc("price")" asp-route-search="@currentSearch" asp-route-type="@currentType"
				   asp-route-qtyMin="@qtyMin" asp-route-qtyMax="@qtyMax" asp-route-status="@status"
				   asp-route-createdFrom="@createdFrom" asp-route-createdTo="@createdTo" class="small">▼</a>
			</th>
			<th class="text-center">
				存量
				<a asp-action="Index" asp-route-sort="@asc("qty")" asp-route-search="@currentSearch" asp-route-type="@currentType"
				   asp-route-qtyMin="@qtyMin" asp-route-qtyMax="@qtyMax" asp-route-status="@status"
				   asp-route-createdFrom="@createdFrom" asp-route-createdTo="@createdTo" class="ms-1 small">▲</a>
				<a asp-action="Index" asp-route-sort="@desc("qty")" asp-route-search="@currentSearch" asp-route-type="@currentType"
				   asp-route-qtyMin="@qtyMin" asp-route-qtyMax="@qtyMax" asp-route-status="@status"
				   asp-route-createdFrom="@createdFrom" asp-route-createdTo="@createdTo" class="small">▼</a>
			</th>
			<th class="text-center">
				狀態
				<a asp-action="Index" asp-route-sort="@asc("status")" asp-route-search="@currentSearch" asp-route-type="@currentType"
				   asp-route-qtyMin="@qtyMin" asp-route-qtyMax="@qtyMax" asp-route-status="@status"
				   asp-route-createdFrom="@createdFrom" asp-route-createdTo="@createdTo" class="ms-1 small">▲</a>
				<a asp-action="Index" asp-route-sort="@desc("status")" asp-route-search="@currentSearch" asp-route-type="@currentType"
				   asp-route-qtyMin="@qtyMin" asp-route-qtyMax="@qtyMax" asp-route-status="@status"
				   asp-route-createdFrom="@createdFrom" asp-route-createdTo="@createdTo" class="small">▼</a>
			</th>
			<th>
				建立時間
				<a asp-action="Index" asp-route-sort="@asc("created")" asp-route-search="@currentSearch" asp-route-type="@currentType"
				   asp-route-qtyMin="@qtyMin" asp-route-qtyMax="@qtyMax" asp-route-status="@status"
				   asp-route-createdFrom="@createdFrom" asp-route-createdTo="@createdTo" class="ms-1 small">▲</a>
				<a asp-action="Index" asp-route-sort="@desc("created")" asp-route-search="@currentSearch" asp-route-type="@currentType"
				   asp-route-qtyMin="@qtyMin" asp-route-qtyMax="@qtyMax" asp-route-status="@status"
				   asp-route-createdFrom="@createdFrom" asp-route-createdTo="@createdTo" class="small">▼</a>
			</th>
			<th>最後異動</th>
			<th style="width:220px;" class="text-end">操作</th>
		</tr>
	</thead>
	<tbody>
		@foreach (var x in Model)
		{
			<tr>
				<td>@x.ProductName</td>
				<td>@x.ProductType</td>
				<td class="text-end">@x.Price.ToString("N0")</td>
				<td class="text-center">@x.ShipmentQuantity</td>
				<td class="text-center">
					@if (x.IsActive)
					{
						<span class="badge bg-success">上架</span>
					}
					else
					{

						<span class="badge bg-secondary">下架</span>
					}
				</td>
				<td>
					<!-- 單擊：顯示建立資訊 -->
					<a href="#" class="text-decoration-underline"
					   data-bs-toggle="modal" data-bs-target="#createdModal"
					   data-created="@x.ProductCreatedAt.ToString("yyyy/MM/dd HH:mm:ss")"
					   data-manager="@x.CreatedByManagerId">
						@x.ProductCreatedAt.ToString("yyyy/MM/dd tt hh:mm")
					</a>
				</td>
				<td>
					@if (x.LastLog is not null)
					{
						<a href="#" data-bs-toggle="modal" data-bs-target="#lastLogModal"
						   data-changed="@x.LastLog.ChangedAt.ToString("yyyy/MM/dd HH:mm:ss")"
						   data-manager="@x.LastLog.ManagerId">
							@x.LastLog.ChangedAt.ToString("yyyy/MM/dd tt hh:mm")
						</a>
					}
					else
					{
						<span class="text-muted small">尚無異動紀錄</span>
					}
				</td>
				<td class="text-end">
					<a class="btn btn-sm btn-primary" asp-action="Edit" asp-route-id="@x.ProductId">Edit</a>
					<a class="btn btn-sm btn-info text-white" asp-action="Details" asp-route-id="@x.ProductId">Detail</a>
					<a class="btn btn-sm btn-danger" asp-action="Delete" asp-route-id="@x.ProductId">Delete</a>
				</td>
			</tr>
		}
	</tbody>
</table>

<!-- 🔢 分頁（縮略 + 保留條件） -->
@{
	int startPage = Math.Max(1, page - 2);
	int endPage = Math.Min(lastPage, page + 2);
}
<div class="d-flex justify-content-center mt-4">
	<div class="btn-group btn-group-lg">
		@*拉寬
		第 @(page) / @(lastPage) 頁，共 @(total) 筆
	</div>
	<div class="btn-group">
		<a class="btn btn-sm btn-outline-secondary @(page <= 1 ? "disabled" : null)"
		   asp-action="Index" asp-route-page="@(page - 1)" asp-route-pageSize="@pageSize"
		   asp-route-search="@currentSearch" asp-route-type="@currentType"
		   asp-route-qtyMin="@qtyMin" asp-route-qtyMax="@qtyMax"
		   asp-route-status="@status" asp-route-createdFrom="@createdFrom" asp-route-createdTo="@createdTo"
		   asp-route-sort="@sort">上一頁</a>

		@if (startPage > 1)
		{
			<a class="btn btn-sm @(page == 1 ? "btn-primary" : "btn-outline-secondary")"
			   asp-action="Index" asp-route-page="1" asp-route-pageSize="@pageSize"
			   asp-route-search="@currentSearch" asp-route-type="@currentType"
			   asp-route-qtyMin="@qtyMin" asp-route-qtyMax="@qtyMax"
			   asp-route-status="@status" asp-route-createdFrom="@createdFrom" asp-route-createdTo="@createdTo"
			   asp-route-sort="@sort">1</a>
			@if (startPage > 2)
			{
				<span class="btn btn-sm btn-light disabled">…</span>
			}
		}

		@for (int i = startPage; i <= endPage; i++)
		{
			<a class="btn btn-sm @(i==page?"btn-primary":"btn-outline-secondary")"
			   asp-action="Index" asp-route-page="@i" asp-route-pageSize="@pageSize"
			   asp-route-search="@currentSearch" asp-route-type="@currentType"
			   asp-route-qtyMin="@qtyMin" asp-route-qtyMax="@qtyMax"
			   asp-route-status="@status" asp-route-createdFrom="@createdFrom" asp-route-createdTo="@createdTo"
			   asp-route-sort="@sort">@i</a>
		}

		@if (endPage < lastPage)
		{
			@if (endPage < lastPage - 1)
			{
				<span class="btn btn-sm btn-light disabled">…</span>
			}
			<a class="btn btn-sm @(page==lastPage?"btn-primary":"btn-outline-secondary")"
			   asp-action="Index" asp-route-page="@lastPage" asp-route-pageSize="@pageSize"
			   asp-route-search="@currentSearch" asp-route-type="@currentType"
			   asp-route-qtyMin="@qtyMin" asp-route-qtyMax="@qtyMax"
			   asp-route-status="@status" asp-route-createdFrom="@createdFrom" asp-route-createdTo="@createdTo"
			   asp-route-sort="@sort">@lastPage</a>
		}

		<a class="btn btn-sm btn-outline-secondary @(page >= lastPage ? "disabled" : null)"
		   asp-action="Index" asp-route-page="@(page + 1)" asp-route-pageSize="@pageSize"
		   asp-route-search="@currentSearch" asp-route-type="@currentType"
		   asp-route-qtyMin="@qtyMin" asp-route-qtyMax="@qtyMax"
		   asp-route-status="@status" asp-route-createdFrom="@createdFrom" asp-route-createdTo="@createdTo"
		   asp-route-sort="@sort">下一頁</a>
	</div>
</div>

<!-- 🪟 建立資訊 -->
<div class="modal fade" id="createdModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<!-- ⬅️ 加上 centered -->
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">建立資訊</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<p><strong>建立時間：</strong><span id="createdAt"></span></p>
				<p><strong>建立人：</strong><span id="createdBy"></span></p>
			</div>
		</div>
	</div>
</div>

<!-- 🪟 最後異動 -->
<div class="modal fade" id="lastLogModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<!-- ⬅️ 置中 -->
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">最後異動資訊</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<p><strong>最後異動時間：</strong><span id="lastChangedAt"></span></p>
				<p><strong>異動人：</strong><span id="lastChangedBy"></span></p>
			</div>
		</div>
	</div>
</div>

@section Scripts {
	<script>
		document.addEventListener('DOMContentLoaded', () => {
			// 建立資訊
			const createdModal = document.getElementById('createdModal');
			createdModal.addEventListener('show.bs.modal', function (event) {
				const link = event.relatedTarget;
				document.getElementById('createdAt').textContent = link.getAttribute('data-created') ?? '-';
				document.getElementById('createdBy').textContent = link.getAttribute('data-manager') ?? '-';
			});

			// 最後異動
			const lastLogModal = document.getElementById('lastLogModal');
			lastLogModal.addEventListener('show.bs.modal', function (event) {
				const link = event.relatedTarget;
				document.getElementById('lastChangedAt').textContent = link.getAttribute('data-changed') ?? '-';
				document.getElementById('lastChangedBy').textContent = link.getAttribute('data-manager') ?? '-';
			});
		});
	</script>
} *@ 




@*1.0初版 @model IEnumerable<GameSpace.Models.ProductInfo>

@{
    ViewData["Title"] = "Index";
}

<h1>Index</h1>

<p>
    <a asp-action="Create">Create New</a>
</p>
<table class="table">
    <thead>
        <tr>
            <th>
                @Html.DisplayNameFor(model => model.ProductName)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.ProductType)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Price)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.CurrencyCode)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.ShipmentQuantity)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.ProductCreatedAt)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.ProductUpdatedAt)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.IsActive)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.ProductCreatedByNavigation)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.ProductUpdatedByNavigation)
            </th>
            <th></th>
        </tr>
    </thead>
    <tbody>
@foreach (var item in Model) {
        <tr>
            <td>
                @Html.DisplayFor(modelItem => item.ProductName)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.ProductType)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Price)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.CurrencyCode)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.ShipmentQuantity)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.ProductCreatedAt)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.ProductUpdatedAt)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.IsActive)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.ProductCreatedByNavigation.ManagerId)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.ProductUpdatedByNavigation.ManagerId)
            </td>
            <td>
                <a asp-action="Edit" asp-route-id="@item.ProductId">Edit</a> |
                <a asp-action="Details" asp-route-id="@item.ProductId">Details</a> |
                <a asp-action="Delete" asp-route-id="@item.ProductId">Delete</a>
            </td>
        </tr>
}
    </tbody>
</table>  *@-->
