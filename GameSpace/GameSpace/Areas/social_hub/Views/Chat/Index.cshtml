@model IEnumerable<GameSpace.Areas.social_hub.Models.ViewModels.ConversationListItemVM>

@{
    ViewData["Title"] = "我的對話";
    // [說明] 從 Query 判斷是否為管理員對話模式，並在所有連結/表單中帶回去
    var isManagerDm = string.Equals(Context.Request.Query["isManagerDm"], "true", StringComparison.OrdinalIgnoreCase);
}

<h2 class="mb-3">@ViewData["Title"]</h2>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="small text-muted">
        模式：@(isManagerDm ? "管理員對管理員" : "使用者對使用者")
    </div>

    @* [URL] GET /social_hub/Chat/With?otherId={id}&isManagerDm={true|false}
       [用途] 右上角快速開啟對話 *@
    <form asp-action="With" method="get" class="d-flex align-items-center gap-2">
        <input type="hidden" name="isManagerDm" value="@(isManagerDm ? "true" : "false")" />
        <input type="number" class="form-control form-control-sm me-2" name="otherId" min="1"
               placeholder="[輸入對方ID]" required />
        <button class="btn btn-sm btn-success" type="submit">開啟</button>
    </form>
</div>

@if (Model == null || !Model.Any())
{
    <div class="alert alert-info">
        目前沒有對話。你可以用網址
        <code>/social_hub/Chat?otherId=對方ID&amp;isManagerDm=@(isManagerDm.ToString().ToLower())</code>
        開始對話，或使用右上角輸入框快速開啟。
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>對方ID</th>
                    <th>最後訊息時間</th>
                    <th>未讀</th>
                    <th style="width:140px;"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var c in Model)
                {
                    <tr>
                        <td>@c.OtherId</td>
                        <td>@(c.LastMessageAt?.ToLocalTime().ToString("yyyy/MM/dd HH:mm") ?? "-")</td>
                        <td>
                            @if (c.UnreadCount > 0)
                            {
                                <span class="badge bg-warning text-dark">@c.UnreadCount</span>
                            }
                            else
                            {
                                <span class="text-muted">0</span>
                            }
                        </td>
                        <td>
                            @* [URL] GET /social_hub/Chat/With?otherId={id}&isManagerDm={true|false} *@
                            <a class="btn btn-sm btn-outline-primary"
                               asp-action="With"
                               asp-route-otherId="@c.OtherId"
                               asp-route-isManagerDm="@(isManagerDm ? "true" : "false")">
                                進入
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
