@using GameSpace.Infrastructure.Login
@inject ILoginIdentity Login

@{
    // 用統一身分介面讀取狀態（外部 AdminCookie 優先）
    var me = await Login.GetAsync();

    var isLogin = me.IsAuthenticated;
    var kind = me.Kind ?? "";
    var isManager = string.Equals(kind, "manager", StringComparison.OrdinalIgnoreCase);

    // 顯示名稱（我們的 AdminCookie 只放了 NameIdentifier，所以用「角色 #ID」）
    var uname = isLogin
        ? (isManager ? $"Manager #{me.EffectiveId}" : $"User #{me.EffectiveId}")
        : "登入";

    // 若要 returnUrl（目前快速登入會導回 WhoAmI，可不必帶）
    var returnUrl = (Context.Request.Path + Context.Request.QueryString).ToString();

    // 樣式
    var navLinkClass = "nav-link text-white";
}

<nav class="navbar navbar-expand-lg navbar-dark shadow-sm custom-bg-dark">
    <div class="container-fluid p-0 d-flex">

        <!-- 左側品牌 -->
        <div class="d-flex justify-content-center align-items-center flex-shrink-0" style="width:250px; height:100%;">
            <a class="navbar-brand mb-0 text-white" asp-area="" asp-controller="Home" asp-action="Index">
                GameSpace
            </a>
        </div>

        <!-- 中間導航 -->
        <div class="collapse navbar-collapse justify-content-center" id="navbarNav1">
            <ul class="navbar-nav">
                <li class="nav-item mx-2">
                    <a class="@navLinkClass" asp-area="social_hub" asp-controller="MessageCenter" asp-action="Index">
                        訊息中心
                    </a>
                </li>
                <li class="nav-item mx-2">
                    <a class="@navLinkClass" asp-area="social_hub" asp-controller="Home" asp-action="WhoAmI">
                        登入測試
                    </a>
                </li>
            </ul>
        </div>

        <!-- 右側使用者選單 -->
        <div class="d-flex align-items-center me-3">
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle text-white d-flex align-items-center" href="#" id="userDropdown1" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <span class="d-none d-lg-inline me-2">@uname</span>
                        <img class="img-profile rounded-circle" src="~/lib/image/undraw_profile.svg" style="width:30px; height:30px; object-fit:cover;">
                    </a>

                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown1">
                        @if (!isLogin)
                        {
                            <!-- 只保留快速登入（直接重簽 AdminCookie）-->
                            <li>
                                <a class="dropdown-item"
                                   asp-area="social_hub"
                                   asp-controller="Home"
                                   asp-action="LoginUser"
                                   asp-route-uid="10000001">
                                    快速登入：User #10000001
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item"
                                   asp-area="social_hub"
                                   asp-controller="Home"
                                   asp-action="LoginUser"
                                   asp-route-uid="10000012">
                                    快速登入：User #10000012
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item"
                                   asp-area="social_hub"
                                   asp-controller="Home"
                                   asp-action="LoginManager"
                                   asp-route-mid="30000001">
                                    快速登入：Manager #30000001
                                </a>
                            </li>
                            <li><hr class="dropdown-divider" /></li>
                            <li>
                                <a class="dropdown-item"
                                   asp-area="social_hub"
                                   asp-controller="Home"
                                   asp-action="WhoAmI">
                                    查看登入狀態
                                </a>
                            </li>
                        }
                        else
                        {
                            <li>
                                <a class="dropdown-item"
                                   asp-area="social_hub"
                                   asp-controller="Home"
                                   asp-action="WhoAmI">
                                    我的狀態
                                </a>
                            </li>
                            <li><a class="dropdown-item" href="#">設定</a></li>
                            <li><hr class="dropdown-divider" /></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#logoutModal">登出</a></li>
                        }
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Logout Modal -->
<div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logoutModalLabel">登出確認</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                確定要登出嗎？
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>

                <!-- 你的 Logout 是 GET，所以這裡用 GET -->
                <form asp-area="social_hub"
                      asp-controller="Home"
                      asp-action="Logout"
                      method="get"
                      class="d-inline">
                    <button type="submit" class="btn btn-primary">確定登出</button>
                </form>

                @* 若未來改成 [HttpPost] Logout，就把上面改為 method="post" 並加 AntiForgeryToken *@
                @* @Html.AntiForgeryToken() *@
            </div>
        </div>
    </div>
</div>
