@{
    // 先讀新的 gs cookie
    var gsId = Context.Request.Cookies["gs_id"];
    var gsKind = Context.Request.Cookies["gs_kind"]; // user / manager
    bool hasGs = !string.IsNullOrWhiteSpace(gsId);

    bool isManagerByGs = string.Equals(gsKind, "manager", StringComparison.OrdinalIgnoreCase);
    bool isUserByGs = string.Equals(gsKind, "user", StringComparison.OrdinalIgnoreCase);

    // 相容舊 cookie（若沒設 gs）
    bool legacyIsAdmin = (Context.Request.Cookies.TryGetValue("sh_is_admin", out var flag) && flag == "1")
                         || Context.Request.Cookies.ContainsKey("sh_mid");
    bool legacyIsUser = Context.Request.Cookies.ContainsKey("sh_uid");

    var isAdminLogin = hasGs ? isManagerByGs : legacyIsAdmin;
    var isUserLogin = hasGs ? isUserByGs : legacyIsUser;
    var isLogin = isAdminLogin || isUserLogin;

    // 顯示名稱：優先舊的名稱 cookie，沒有就 fallback 用 ID
    string uname;
    if (isAdminLogin)
        uname = Context.Request.Cookies["sh_mname"] ?? (hasGs ? $"Manager #{gsId}" : "管理員");
    else if (isUserLogin)
        uname = Context.Request.Cookies["sh_uname"] ?? (hasGs ? $"User #{gsId}" : "訪客");
    else
        uname = "登入";

    var returnUrl = (Context.Request.Path + Context.Request.QueryString).ToString();
}

<nav class="navbar navbar-expand-lg navbar-dark shadow-sm custom-bg-dark">
    <div class="container-fluid p-0 d-flex">

        <!-- 左側 GameSpace / 背景區，固定寬度 -->
        <div class="d-flex justify-content-center align-items-center flex-shrink-0" style="width:250px; height:100%;">
            <a class="navbar-brand mb-0 text-white" asp-area="" asp-controller="Home" asp-action="Index">
                GameSpace
            </a>
        </div>

        <!-- 中間導航 -->
        <div class="collapse navbar-collapse justify-content-center" id="navbarNav1">
            <ul class="navbar-nav">
                <li class="nav-item mx-2">
                    <a class="nav-link text-white" asp-area="social_hub" asp-controller="Home" asp-action="Index">
                        訊息中心
                    </a>
                </li>
                <li class="nav-item mx-2">
                    <a class="nav-link text-white" asp-area="social_hub" asp-controller="Home" asp-action="WhoAmI">
                        登入測試
                    </a>
                </li>
                <li class="nav-item mx-2">
                    <a class="nav-link text-white" asp-area="social_hub" asp-controller="Mutes" asp-action="Index">
                        穢語設定
                    </a>
                </li>
                <li class="nav-item mx-2">
                    <a class="nav-link text-white" asp-area="social_hub" asp-controller="Chat" asp-action="Index">
                        聊天測試
                    </a>
                </li>
            </ul>
        </div>

        <!-- 右側使用者選單 -->
        <div class="d-flex align-items-center me-3">
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle text-white d-flex align-items-center" href="#" id="userDropdown1" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <span class="d-none d-lg-inline me-2">@uname</span>
                        <img class="img-profile rounded-circle" src="~/lib/image/undraw_profile.svg" style="width:30px; height:30px; object-fit:cover;">
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown1">
                        @if (!isLogin)
                        {
                            <li>
                                <a class="dropdown-item"
                                   asp-area="social_hub"
                                   asp-controller="Home"
                                   asp-action="UserLogin"
                                   asp-route-returnUrl="@(returnUrl)">
                                    使用者登入
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item"
                                   asp-area="social_hub"
                                   asp-controller="Home"
                                   asp-action="AdminLogin"
                                   asp-route-returnUrl="@(returnUrl)">
                                    管理員登入
                                </a>
                            </li>
                        }
                        else
                        {
                            <li><a class="dropdown-item" href="#">測試</a></li>
                            <li><a class="dropdown-item" href="#">設定</a></li>
                            <li><hr class="dropdown-divider" /></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#logoutModal">登出</a></li>
                        }
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Logout Modal -->
<div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logoutModalLabel">登出確認</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                確定要登出嗎？
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>

                <!-- 你的 Logout 是 GET，所以這裡改成 GET（或改成超連結） -->
                <form asp-area="social_hub"
                      asp-controller="Home"
                      asp-action="Logout"
                      method="get"
                      class="d-inline">
                    <button type="submit" class="btn btn-primary">確定登出</button>
                </form>

                @* 如果你改成 [HttpPost] Logout，就把上面改回 method="post" 並加 AntiForgery *@
                @* @Html.AntiForgeryToken() *@
            </div>
        </div>
    </div>
</div>
